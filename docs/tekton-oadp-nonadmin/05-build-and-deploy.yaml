---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: oadp-non-admin
  namespace: oadp-non-admin
  labels:
    app.kubernetes.io/name: oadp-non-admin
    app.kubernetes.io/instance: oadp-non-admin-backup
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: oadp-non-admin
spec:
  accessModes: [ReadWriteOnce]
  resources:
    requests:
      storage: 500Mi
---
kind: Task
apiVersion: tekton.dev/v1beta1
metadata:
  name: debug
  namespace: oadp-non-admin
  description: collect git repo debug information 
spec:
  # notes: each task specifies the workspace name
  # the same pvc is used, only the mounted directory changes based on the name
  # in this case "debug"
  workspaces:
    - name: debug
  results: 
    - name: list-files
      description: lists the repos files
  steps:
    - name: list-workspace-files
      image: ubi9/toolbox
      script: |
        set -ex
        cd /workspace/debug 
        ls -la
    - name: update backup custom resource
      image: ubi9/toolbox
      
---
kind: Pipeline
apiVersion: tekton.dev/v1beta1
metadata:
  name: backup-pipeline
  namespace: oadp-non-admin
  labels:
    app.kubernetes.io/name: oadp-non-admin
    app.kubernetes.io/instance: oadp-non-admin-backup
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: oadp-non-admin
spec:
  params:
    - default: 'https://github.com/migtools/oadp-tekton.git'
      name: git-url
      type: string
    - name: BACKUP_NAME
      type: string
  tasks:
    - name: import-images
      params:
        - name: SCRIPT
          value: >
            oc import-image toolbox
            --from=registry.access.redhat.com/ubi9/toolbox:latest --confirm -n
            oadp-non-admin
      taskRef:
        kind: ClusterTask
        name: openshift-client
    - name: checkout
      params:
        - name: url
          value: 'https://github.com/migtools/oadp-tekton.git'
      runAfter:
        - import-images
      taskRef:
        kind: ClusterTask
        name: git-clone
      timeout: 1m0s
      workspaces:
        - name: output
          workspace: repo
    - name: listfiles
      runAfter:
        - checkout
      taskRef:
        kind: Task
        name: debug
      workspaces:
        - name: debug
          workspace: repo
    - name: triggerbackup
      params:
        - name: SCRIPT
            value: >
              printf "echo the BACKUP_NAME parameter \n"

              echo victoryismine01

              printf "\n"

              printf "cat the original backup cr \n"

              cat /workspace/manifest-dir/backup.yml

              printf "\n"

              printf "Update the backup cr's name\n"

              sed -i 's/wesfoo01/victoryismine01/'
              /workspace/manifest-dir/backup.yml

              printf "\n"

              printf "cat the updated backup cr \n"

              cat /workspace/manifest-dir/backup.yml

              printf "\n"

              printf "Finally create the backup\n"

              oc create -f /workspace/manifest-dir/backup.yml

              printf "\n"

              printf "Get the details and status of the backup\n"

              oc get backup victoryismine01 -n openshift-adp -o yaml

              printf "\n"
        - name: VERSION
          value: latest
      runAfter:
        - listfiles
      taskRef:
        kind: ClusterTask
        name: openshift-client
      workspaces:
        - name: manifest-dir
          workspace: repo
  workspaces:
    - name: repo
  
        
              
